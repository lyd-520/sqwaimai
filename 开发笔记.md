# 环境
1、MongoDB  
  下载4.0版本   https://www.mongodb.com/download-center/community

  windows 安装mongodb服务: C:\mongodb\bin\mongod.exe --config "C:\mongodb\mongod.cfg" --install

mongod.cfg内容：
```
systemLog:
    destination: file
    path: D:\dev-hook\mongodb-win32-x86_64-2008plus-ssl-4.0.28\log\mongod.log
storage:
    dbPath: D:\dev-hook\mongodb-win32-x86_64-2008plus-ssl-4.0.28\db\
```



​	初始化数据在elm包中。

```
mongorestore.exe -d flash-waimai d:\\elm
```

2、MySQL  
创建数据库waimai，初始化脚本在elm包中  
3、申请腾讯地图Key

​	https://lbs.qq.com/dev/console/application/mine  申请了3个key

| waimai1 | 57KBZ-6BDWD-FXB4P-P6OV7-S4KDO-UCFQ2 |
| ------- | ----------------------------------- |
| waimai2 | 3KHBZ-HTPWR-SU6WM-WIMA5-NUOZQ-7CFSU |
| waimai3 | CA7BZ-ZPGKR-MMOWX-WF3NV-FSOTE-CJF6U |

​	申请的key需要打开webserviceAPI权限。

​	{"status":199,"message":"此key未开启WebserviceAPI功能","request_id":"f460524d991548a49a9e7cef2eb1754c"}

4、申请百度地图key

​	申请好麻烦。 懒得搞了。 就用他现成的把。 

# 启动项目
1、admin-app项目

​	创建waimai数据库即可。 在配置文件中打开spring.jpa.hibernate.ddl-auto=create配置，就会执行import.sql执行数据初始化。

2、启动manage项目

​	npm install --registry=https://registry.npm.taobao.org

​	这样安装的时候报错了。 版本冲突。 引入了 html-webpack-plugin@4.0.0-alpha  和 peer html-webpack-plugin@"^3.0.0" from script-ext-html-webpack-plugin@2.0.1 冲突了。 可以加个--force指令，强行安装。后面还是把版本升了一下。 script-ext-html-webpack-plugin@2.1.5+html-webpack-plugin@4.0.0

​	报需要python2什么的错误。又是node-sass插件的版本问题。 需要与node版本相对应。 node16版本需要node-sass版本6.0+

3、启动mobile项目

​	还是要调整下node-sass的版本。调了之后又是一堆的版本  sass-loader升级到10.0.1版本，不然会跟sass版本冲突。

​	//    "webpack": "^1.13.2",  这个依赖版本又跟sass-loader的版本冲突。 改为5.0.0。又跟babel-loader版本冲突。

​	nodejs版本只能用14。安装了nvm来管理nodejs的版本。



# 问题

## 1、代码自动生成模块先不管了。

## 2、数据库是如何初始化的？

​	只要打开spring.jpa.hibernate.ddl-auto=create配置，然后就会执行import.sql。

​	这个文件地址可以通过hibernate.hbm2ddl.import_files属性指定，默认值就是import.sql

见org.hibernate.tool.schema.internal.SchemaCreatorImpl类

```
String importFiles = ConfigurationHelper.getString("hibernate.hbm2ddl.import_files", options.getConfigurationValues(), "/import.sql");
```

## 3、登录
​	admin项目自己创建后台用户 默认 admin admin

​	商家可以用商铺名称登录，密码123456

​	客户登录 直接写用户名、密码、验证码就行。 新用户会自动创建。  client1 123456 旧的用户http获取客户端IP需要输入正确的密码。 

​		客户信息保存在mongoDB中，Colllections=users , 然后密码是加密保存的。 

​	String newPassword = MD5.getMD5String(MD5.getMD5String(loginVo.getPassword()).substring(2, 7) + MD5.getMD5String(loginVo.getPassword()));

## 4、地址没弄明白。

​	默认根据IP地址定位到了上海市，然后很多地方输入地址，都是搜索上海市的地址。没办法搜索其他城市。	

​		他这里获取IP地址的逻辑有点问题。 是从客户端请求头中获取 x-forwarded-for 参数。如果没有的话，默认指定一个测试IP  101.81.121.39。 但是请求的时候都没有这个属性啊。根本获取不到客户端的IP。方法当中还传了个type属性，但是却完全没有用。什么鬼，乱七八糟的。

​		获取IP这个地方问题太大了！！从request中，可以获取到remoteAddr，这是原始请求或者最后一个代理服务器的地址。而从header中获取X-Forwarede-For，拿到的应该也是代理过的地址。

> 从请求头获取地址测了好久。内网可以通过request的remodeAddr来获取。如果用ngrok开通内网穿透的话，ngrok会在请求头中增加一个x-real-ip的参数，把请求的真实IP填充进来。
>
> 难道要买一个稳定的ngrok服务？
>
> 要不改成预设一个服务端的位置，只给同城市提供外卖服务好了？不知道这样影响有多大，还要再看找商店的逻辑。

​		这里不如改成在参数配置里指定一个服务器IP好了，这样就只在一个市区内服务。

```
https://apis.map.qq.com/ws/location/v1/ip?key=57KBZ-6BDWD-FXB4P-P6OV7-S4KDO-UCFQ2&ip=36.111.200.0
```

​		175.13.249.136长沙这边的一个IP。

​		做了个假，把地址搜索给糊弄过去了，又发现添加收货地址的时候，选择了地址，但是没有回填。

## 5、admin的登录超时问题

​	管理前端 登录后。一段时间不操作，后端就会超时。而前端所有查后端数据的操作就会失败。但是前端从cookie判断自己一直是登录的，一进入登录页就会转到dashboard主页，无法重新登录，就只能一直超时。除非清空cookie

​	神他妈的登录逻辑。 我操。每次后端请求的时候监测密码是不是对？？？有病把这是。

​	不对啊 。同样的Token，然后都是传到后台。Shiro通过APIRealm进行authentication的时候，是通过JWT工具来判断的。每次都是这个地方判断出错？？

```
if (!JwtUtil.verify(token, accountInfo.getUsername(), userBean.getPassword())) {
    throw new AuthenticationException("Username or password error");
}
```

​	为什么会是这里呢？token存到前端就没动过啊？accountInfo是从token中解析出来的，userBean是登录时缓存进去的，token也是在登录时根据user生成的。为什么会检验不通过啊？

​	要不然问题就出在ehcache缓存上。登录后用户会存入到ehcache中，然后他的超时时间是3600秒。超时后会去数据库里查。 数据库里存的是加密后的密码。写入的时候呢？也是写的同样的密码啊？为什么会不一样呢？

# 进度

2022年11月29日 重新搭建了一个环境，把项目名和包名全部改了。

问题



client-ui

​	1、http://localhost:8000/#/benefit 查看我的优惠券 页面报错

​	2、http://localhost:8000/#/profile/info 账户信息页面 上传头像报错   http://localhost:8000/eus/v1/users/29411/avatar 请求地址不存在



2022年11月30日 垃圾项目全是一些非常弱智的BUG。 这开个毛的源啊。真的烦躁。

添加收货地址：

addDetail.vue里addressList的变量名弄错了，导致选择不了地址。

改完了之后，从addDetail.vue里选择的地址会放到state里，应该是要给add.vue的，但是add.vue根本没有从state中去更新，连getter都没有

改好了新增收货地址，删除收货地址又报404。 删除用的DELETE，CONTROLLER里是POST。改了方法，然后发现Controller配置的地址又不对。要使用{user_id}，他给配个${user_id}。全是这些弱智得不行的东西。 真他妈的无语。

个人信息页，展现了一堆内容。但是userInfo对象，只有id,password,user_id,user_name四个属性，其他的全都是没有的。 这搞你妈个逼啊。获取用户信息是从后台查的，不是在登录时弄到前端的。

手机号码也没有办法绑定

个人信息那里的坑算是差不多了。 手机号维护不了就维护不了吧。 不弄了。

首页需要定位城市，把这个页面上所有选择的城市都去掉了。

选择完地点后，进入msite页面，查找商店。这他妈的又是个大坑。

前端传了一大堆的参数，后端只用了几个。 搜索

​	-- 基础资料这里还是有个坑。所有的图片都是按照图片名去t_sys_fileinfo表里查的，但是这个表里并没有做去重。如果有多个文件名一样的记录，后台直接抛异常了，前台就是拿不到图片，没有任何提示！！！ 后面再看要不要弄吧。 是不是可以直接在数据库里加个唯一索引完事？

、

2022年12月1日 

添加店铺：每个分类建一个把。

日韩料理   添加种类  日料   棒子 再添加食品

 西餐   添加两种食品

快餐便当

小吃夜宵

果蔬生鲜

特色菜系

 新添加的商铺不能直接登录，需要管理员先停用，再启用之后才能登录。 商铺状态有问题。 

​	新添加的商铺disabled是空的。  管理页面，disabled==0 显示停用按钮 应该表示状态为已启用。 disabled==1显示启用按钮，应该表示状态为已停用

​	都添加了几个食品。添加完后需要管理员审核



又发现一个BUG。 登录后过了一段时间，所有请求都报401。 但是，也进不了登录页，也无法退出。原因可能是后端登录超时了，前端却没有超时。 试了好多操作都不行， 只能重启前端应用。

前端通过cookie判断是否登录。如果登录完成，直接从登录页跳转到dashboard页。

​	如果不是登录页，访问后台/account/info获取用户信息。。根据用户信息生成对应的路由对象，这样就可以控制每个用户只能访问自己的路径了。这倒是一个可以借鉴的地方。

​	访问/account/info时，会从请求头拿到前台cookie中的Token，这个tokne是一个JWT字符串，从中可以解析出username,userid,usertype,password，构建出accountInfo

​	后台shiro框架没有放开/account/info



主流程下单后直接完成支付了。 点击订单，又报了个弱智的404 http://localhost:8082/bos/v1/users/29411/orders/9813/snapshot?t=1669873450859 

​	订单详情看不了。 因为/business/orderdetail这个菜单地址在后台没有配置权限。要给admin用户配置这个菜单权限。

​	但是在菜单管理页面根本查不出这个菜单。看了下，是因为数据库里订单详情菜单的pcode配错了。



现在从上商品到下订单，流程都已经通了。 但是店铺的结算还不知道是怎么结算的。

​	--我操，这他妈结算又是个假的，在shop中定义了一个UnliquidatedAmount字段表示结算金额， 但是结算金额根本就没有计算的地方。初始化给个0，后面一直是0。。然后还设计了一个计算功能，把这个结算金额清空。这都是些什么半吊子功能，拿出来坑人的啊。

​	-- 可以在后续骑手端把订单送达后，增加结算金额把。



client-ui里还有一个搜索功能，只能按全店名搜索店铺。



 后面可以开始规划骑手端了。 前端从client-ui复制算了。

​	--登录

​	--抢单

​	--送单

​	--送达

客户端：

​	-- 订单： 原有的订单详情页有配送信息。查询接口  /bos/v1/users/' + user_id + '/orders/' + orderid + '/snapshot

报404，还没有的。 我操

​			front.order实体中也定义了物流的状态。除了已有的0-初始化，1-已支付，-1 - 已取消外，还有2-商家已接单，3-派送中，4-已完成。难道还要搞个商户端？设计在天上，实现在地下。 --他是在确认下单时直接把订单状态变成已支付了。--这里要改成未支付

​			腾讯地图，可以直接绘制路线图。参考博客https://blog.csdn.net/yinsefeixingchuan/article/details/127315831

​	rider-ui

​	1、进入后直接访问Profile页面





2022年12月4日  改密码那个页面，可以输入账号名，然后根据账号名改密码。。这样可以随意的改别人的密码。什么鬼脑残。无语了。。

​	修改用户名那个功能也是,只改了前端的用户名,没有同步到后端。删掉这个功能。

​	我靠。 发现了一个好大的BUG 。他后端很多Controller方法是用@RequestParam注解接收的参数。这个注解只能接收请求路径上的参数。?aaa=1&bbb=2这样的。但是前端的fetch方法请求时并没有拼凑路径，而是以JSON格式用请求体传的参数，后台接收不到参数的。这个BUG影响的地方就多了！

​	我操他妈的个逼。 用elementui的axios根本没有这么多的麻烦。这狗日的前端。用这fetch方法，@RequestParam只能从请求路径上解析参数。请求体中的参数要用@ResquestBody获取。

​	下午半天就在研究这个传参的问题了。 我操他妈的。这什么垃圾项目，这么基础的功能都封装得这么乱。 这BUG涉及到的地方就非常非常多了，只能看到一个改一个了。我操他妈的，真的烦 ，真的烦，真的烦。这垃圾项目，又烦又没价值！！！！！！！！！！！



2022年12月7日 主流程大致通了。维护食品--客户下单--骑手抢单--骑手送单--客户确认订单--店家接收结算金额

但是发现还有很多问题。 麻烦得要死。 一是 骑手的收益，搞不懂怎么算的。在下订单confirmOrder时，会从carts里弄出一个配送费，固定是4。但是下订单的时候，又不是用的这个配送费。搞不清楚配送费到底是怎么送的。  如果再加上食品的包装费，这些计费逻辑就更复杂了。

二是 垃圾代码怎么优化？ 如果想要做一个项目课程，感觉别人会比较关注代码的整洁程度。 但是目前这整洁程度，简直辣眼睛。按照我的想法，连整个表结构都需要重建。



2022年12月8日 今天找诸葛老师沟通，本来是想要放弃这个费力不讨好的项目的。后来决定说这个项目可以像电商一样，先整理出一个V1版本。然后再慢慢优化。先把主流程的代码调整一下把。 

​	这项目搞得真的是没劲。还是先规划一下怎么把代码调整得整洁一点把。 



2022年12月9日 这几天就是拿着项目到处看看。调整代码真的不知道从何下手。到处先改改把。去掉一些@auth注解。

​	尝试解决一下admin管理平台，登录状态后端超时后，前端无法重新登录的问题。

​		前端登录后，进入/login会直接跳转到/dashboard主页面。这是为什么？

​		在permission.js中定义每次路由跳转前，会检查本地token ，key是Admin-Token。只要有这个token。就会从login跳到主页去。

​			shiro的默认登录过期时间是30分钟，设置为永不过期？

​	尝试解决一下admin管理平台，菜单配置乱七八糟的问题。

​		菜单的code是和一些具体操作的权限绑定的。