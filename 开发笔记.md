# 环境
1、MongoDB  
  下载4.0版本   https://www.mongodb.com/download-center/community

  windows 安装mongodb服务: C:\mongodb\bin\mongod.exe --config "C:\mongodb\mongod.cfg" --install

mongod.cfg内容：
```
systemLog:
    destination: file
    path: D:\dev-hook\mongodb-win32-x86_64-2008plus-ssl-4.0.28\log\mongod.log
storage:
    dbPath: D:\dev-hook\mongodb-win32-x86_64-2008plus-ssl-4.0.28\db\
```



​	初始化数据在elm包中。

```
mongorestore.exe -d flash-waimai d:\\elm
```

2、MySQL  
创建数据库waimai，初始化脚本在elm包中  
3、申请腾讯地图Key

​	https://lbs.qq.com/dev/console/application/mine  申请了3个key

| waimai1 | 57KBZ-6BDWD-FXB4P-P6OV7-S4KDO-UCFQ2 |
| ------- | ----------------------------------- |
| waimai2 | 3KHBZ-HTPWR-SU6WM-WIMA5-NUOZQ-7CFSU |
| waimai3 | CA7BZ-ZPGKR-MMOWX-WF3NV-FSOTE-CJF6U |

​	申请的key需要打开webserviceAPI权限。

​	{"status":199,"message":"此key未开启WebserviceAPI功能","request_id":"f460524d991548a49a9e7cef2eb1754c"}

4、申请百度地图key

​	申请好麻烦。 懒得搞了。 就用他现成的把。 

# 启动项目
1、admin-app项目

​	创建waimai数据库即可。 在配置文件中打开spring.jpa.hibernate.ddl-auto=create配置，就会执行import.sql执行数据初始化。

2、启动manage项目

​	npm install --registry=https://registry.npm.taobao.org

​	这样安装的时候报错了。 版本冲突。 引入了 html-webpack-plugin@4.0.0-alpha  和 peer html-webpack-plugin@"^3.0.0" from script-ext-html-webpack-plugin@2.0.1 冲突了。 可以加个--force指令，强行安装。后面还是把版本升了一下。 script-ext-html-webpack-plugin@2.1.5+html-webpack-plugin@4.0.0

​	报需要python2什么的错误。又是node-sass插件的版本问题。 需要与node版本相对应。 node16版本需要node-sass版本6.0+

3、启动mobile项目

​	还是要调整下node-sass的版本。调了之后又是一堆的版本  sass-loader升级到10.0.1版本，不然会跟sass版本冲突。

​	//    "webpack": "^1.13.2",  这个依赖版本又跟sass-loader的版本冲突。 改为5.0.0。又跟babel-loader版本冲突。

​	nodejs版本只能用14。安装了nvm来管理nodejs的版本。



# 问题

1、代码自动生成模块先不管了。

2、数据库是如何初始化的？

​	只要打开spring.jpa.hibernate.ddl-auto=create配置，然后就会执行import.sql。

​	这个文件地址可以通过hibernate.hbm2ddl.import_files属性指定，默认值就是import.sql

见org.hibernate.tool.schema.internal.SchemaCreatorImpl类

```
String importFiles = ConfigurationHelper.getString("hibernate.hbm2ddl.import_files", options.getConfigurationValues(), "/import.sql");
```

3、登录
	admin项目自己创建后台用户 默认 admin admin

​	商家可以用商铺名称登录，密码123456

​	客户登录 直接写用户名、密码、验证码就行。 新用户会自动创建。  client1 123456 旧的用户http获取客户端IP需要输入正确的密码。 

​		客户信息保存在mongoDB中，Colllections=users , 然后密码是加密保存的。 

​	String newPassword = MD5.getMD5String(MD5.getMD5String(loginVo.getPassword()).substring(2, 7) + MD5.getMD5String(loginVo.getPassword()));

4、地址没弄明白。

​	默认根据IP地址定位到了上海市，然后很多地方输入地址，都是搜索上海市的地址。没办法搜索其他城市。	

​		他这里获取IP地址的逻辑有点问题。 是从客户端请求头中获取 x-forwarded-for 参数。如果没有的话，默认指定一个测试IP  101.81.121.39。 但是请求的时候都没有这个属性啊。根本获取不到客户端的IP。方法当中还传了个type属性，但是却完全没有用。什么鬼，乱七八糟的。

​		获取IP这个地方问题太大了！！从request中，可以获取到remoteAddr，这是原始请求或者最后一个代理服务器的地址。而从header中获取X-Forwarede-For，拿到的应该也是代理过的地址。

> 从请求头获取地址测了好久。内网可以通过request的remodeAddr来获取。如果用ngrok开通内网穿透的话，ngrok会在请求头中增加一个x-real-ip的参数，把请求的真实IP填充进来。
>
> 难道要买一个稳定的ngrok服务？
>
> 要不改成预设一个服务端的位置，只给同城市提供外卖服务好了？不知道这样影响有多大，还要再看找商店的逻辑。

​		这里不如改成在参数配置里指定一个服务器IP好了，这样就只在一个市区内服务。

```
https://apis.map.qq.com/ws/location/v1/ip?key=57KBZ-6BDWD-FXB4P-P6OV7-S4KDO-UCFQ2&ip=36.111.200.0
```

​		175.13.249.136长沙这边的一个IP。

​		做了个假，把地址搜索给糊弄过去了，又发现添加收货地址的时候，选择了地址，但是没有回填。



# 进度

2022年11月29日 重新搭建了一个环境，把项目名和包名全部改了。

问题



client-ui

​	1、http://localhost:8000/#/benefit 查看我的优惠券 页面报错

​	2、http://localhost:8000/#/profile/info 账户信息页面 上传头像报错   http://localhost:8000/eus/v1/users/29411/avatar 请求地址不存在

​	